[gd_scene load_steps=11 format=2]

[ext_resource path="res://Graphics/UI/Teleport/teleport_bg.png" type="Texture" id=1]
[ext_resource path="res://Nodes/Ui/Reusables/Scrollbar.tscn" type="PackedScene" id=2]
[ext_resource path="res://Fonts/EBMain.tres" type="DynamicFont" id=3]

[sub_resource type="GDScript" id=1]
script/source = "extends Control

onready var _scroll = $ScrollContainer
onready var _scroll_bar = $Scrollbar
onready var _label = $ScrollContainer/Label

var soundEffects = {
	'back':load('res://Audio/Sound effects/M3/curshoriz.wav'), 
	'menu_open': load('res://Audio/Sound effects/M3/menu_open.wav'),
	'menu_open2': load('res://Audio/Sound effects/M3/menu_open2.wav'),
}

func _ready():
	global.currentCamera.anchor_mode = 0
	var dialogue = {}
	globaldata.load_data('res://Data/Dialogue/', dialogue)
	call_deferred('_test_dialogue', dialogue)


func _test_dialogue(dialogue):
	var current_locale = TranslationServer.get_locale()
	var font_la = load('res://Fonts/EBMain_la.tres')
	var font_ja = load('res://Fonts/EBMain_ja.tres')
	var chars_la = font_la.get_available_chars()
	var chars_ja = font_ja.get_available_chars()

	var lang_source = global.LANGUAGES_DEBUG[0]

	var dialogue_source = {}

	global.receiver = globaldata.ninten

	for lang in global.LANGUAGES_DEBUG:
		TranslationServer.set_locale(lang)

		_log('')
		
		var counter = 0
		var font = font_la if lang != 'ja' else font_ja
		var available_chars = chars_la if lang != 'ja' else chars_ja

		var problems = []

		available_chars += '\\n' + TextTools.CHAR_WAIT + TextTools.CHAR_DELAY + TextTools.CHAR_BULLET + TextTools.CHAR_PRINTING_FASTER + TextTools.CHAR_PRINTING_NORMAL

		for party_member in [globaldata.ninten, globaldata.ana, globaldata.lloyd, globaldata.teddy, globaldata.pippi]:
			party_member.nickname = tr('LONGEST_POSSIBLE_NAME')

		for json in dialogue:
			if lang == lang_source:
				dialogue_source[json] = {}
			for key in dialogue[json]:
				if dialogue[json][key].has('text'):
					var dialogue_line = tr(dialogue[json][key]['text'])
					if lang == lang_source:
						dialogue_source[json][key] = dialogue_line
					if lang == lang_source or dialogue_line != dialogue_source[json][key]:
						dialogue_line = TextTools.strip_bbcode(TextTools.replace_text(dialogue_line))
						var split_dialogue_line = dialogue_line.split(TextTools.CHAR_WAIT + '\\n')
						for dialogue_segment in split_dialogue_line:
							if font.get_wordwrap_string_size(dialogue_segment, 240).y / font.get_height() > 3:
								problems.append('– Too long: %s' % dialogue_line)
						for c in dialogue_line:
							if not c in available_chars:
								problems.append('– Unknown character “%s” in %s' % [c, dialogue_line])
						counter += 1
		
		if problems.size() == 0:
			_log('%s: %s lines tested, everything OK!' % [TranslationServer.get_locale_name(lang).to_upper(), counter])

		else:
			_log('%s: %s lines tested, %s problems:' % [TranslationServer.get_locale_name(lang).to_upper(), counter, problems.size()])
			for prob in problems:
				_log(prob)
			
	yield(get_tree(), 'idle_frame')
	_update_scrollbar()
	TranslationServer.set_locale(current_locale)

func _physics_process(delta):
	var input = controlsManager.get_controls_vector()
	if input.y > 0:
		_scroll.scroll_vertical += 10
	if input.y < 0:
		_scroll.scroll_vertical -= 10
	_update_scrollbar()

func _log(msg:String):
	print(msg)
	if _label.text != '':
		_label.text += '\\n'
	_label.text += msg

func _update_scrollbar():
	_scroll_bar.update_from_scroll_view(_scroll)

"

[sub_resource type="StyleBoxEmpty" id=3]

[sub_resource type="StyleBoxEmpty" id=4]

[sub_resource type="StyleBoxEmpty" id=5]

[sub_resource type="StyleBoxEmpty" id=6]

[sub_resource type="StyleBoxEmpty" id=7]

[sub_resource type="Theme" id=2]
VScrollBar/icons/decrement = null
VScrollBar/icons/decrement_highlight = null
VScrollBar/icons/decrement_pressed = null
VScrollBar/icons/increment = null
VScrollBar/icons/increment_highlight = null
VScrollBar/icons/increment_pressed = null
VScrollBar/styles/grabber = SubResource( 3 )
VScrollBar/styles/grabber_highlight = SubResource( 4 )
VScrollBar/styles/grabber_pressed = SubResource( 5 )
VScrollBar/styles/scroll = SubResource( 6 )
VScrollBar/styles/scroll_focus = SubResource( 7 )

[node name="DialogueOverflows" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource( 1 )

[node name="TextureRect" type="TextureRect" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
texture = ExtResource( 1 )

[node name="Scrollbar" parent="." instance=ExtResource( 2 )]
anchor_left = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = -10.0
margin_top = 1.0
margin_right = -2.0
margin_bottom = -1.0

[node name="ScrollContainer" type="ScrollContainer" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = 4.0
margin_top = 3.0
margin_right = -12.0
margin_bottom = -3.0
theme = SubResource( 2 )

[node name="Label" type="Label" parent="ScrollContainer"]
margin_right = 304.0
margin_bottom = 12.0
grow_horizontal = 2
grow_vertical = 2
size_flags_horizontal = 3
custom_constants/line_spacing = -1
custom_fonts/font = ExtResource( 3 )
autowrap = true
